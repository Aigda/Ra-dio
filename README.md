Markdown

# 📡 WiFi Direct Text Transceiver

> **Текстовая рация на вашем смартфоне — без интернета, без регистрации, без паролей**

[![Android](https://img.shields.io/badge/Android-5.0+-green.svg)](https://developer.android.com)
[![WiFi Direct](https://img.shields.io/badge/WiFi-Direct-blue.svg)](https://www.wi-fi.org/discover-wi-fi/wi-fi-direct)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

---

## 🎯 Что это?

Это приложение превращает обычный Android-смартфон в **цифровую текстовую рацию**.

Никакой инфраструктуры. Никаких серверов. Никакой регистрации.

**Включил — и ты в эфире.**
┌─────────────────────────────────────────────────────────────┐
│ │
│ 📱 ← - - - - WiFi Direct - - - - → 📱 │
│ │
│ "Привет!" "Принял!" │
│ │
│ Дальность: 50-200 метров │
│ Задержка: 2-15 секунд │
│ Стоимость: 0 ₽ │
│ │
└─────────────────────────────────────────────────────────────┘




---

## ✨ Ключевые особенности

### 🔓 Никакой регистрации
- Нет аккаунтов
- Нет паролей
- Нет QR-кодов
- Нет подтверждения номера телефона

### 📻 Как настоящая рация
- Все видят всех — как радиостанции в эфире
- Твой Device ID — это твой позывной
- Не нужно создавать локальную сеть
- Не нужно подключаться к роутеру
- Не нужно знать IP-адреса

### 💰 Бесплатно
- Без интернета
- Без SMS
- Без подписок
- Работает везде, где есть WiFi-модуль

---

## 📖 Оглавление

- [Как это работает](#-как-это-работает)
- [Архитектура сообщений](#-архитектура-сообщений)
- [Жизненный цикл сообщения](#-жизненный-цикл-сообщения)
- [Синхронизация](#-синхронизация--восстановление-после-сбоев)
- [Защита от дубликатов](#-session-id--защита-от-призраков)
- [Технические детали](#-технические-детали)
- [Практические советы](#-практические-советы)
- [Формат протокола](#-приложение-формат-протокола)

---

## 🔬 Как это работает

### Аналогия с радиосвязью

Представьте старые добрые рации. Вы нажимаете кнопку PTT (Push-to-Talk), говорите в микрофон, отпускаете — и слушаете эфир. Все, кто на той же частоте, слышат вас.

**WiFi Direct работает точно так же**, только вместо голоса — текст, а вместо частоты — специальные DNS-SD сервисы.

| Классическая рация | WiFi Direct Transceiver |
|-------------------|------------------------|
| PTT (Push-to-Talk) | Регистрация DNS-SD сервиса |
| Голосовое сообщение | TXT-запись с текстом |
| Частота/канал | Имя сервиса (WFD_Main, WFD_Msg) |
| Позывной | Device ID (8 символов) |
| "Приём, как слышно?" | Heartbeat каждые 5 секунд |
| "Принял, конец связи" | ACK (подтверждение доставки) |

### Heartbeat — «Я на связи!»

Каждые 5 секунд устройство «выходит в эфир» и объявляет:
📡 WFD_Main:
id = "a1b2c3d4" ← Мой позывной
sid = "695bf5e3" ← Когда я вышел в эфир
hb = "42" ← Счётчик передач




Другие устройства постоянно сканируют эфир. Если heartbeat не обновлялся более 20 секунд — станция считается «молчащей».

---

## 📬 Архитектура сообщений

### Проблема

DNS-SD (Service Discovery) создавался не для передачи сообщений. Это как отправлять письма почтовыми голубями — можно, но нужна смекалка.

### Решение: Слотовая система

Для передачи используются **3 слота** — как 3 частоты для разных сообщений:
┌─────────────────────────────────────────────────────────────┐
│ 📻 СЛОТЫ СООБЩЕНИЙ │
├─────────────────────────────────────────────────────────────┤
│ │
│ WFD_Msg0 WFD_Msg1 WFD_Msg2 │
│ ┌───────────┐ ┌───────────┐ ┌───────────┐ │
│ │ "Привет!" │ │ (свободен)│ │ (свободен)│ │
│ │ → b5c6... │ │ │ │ │ │
│ │ ⏳ ждём ACK│ │ │ │ │ │
│ └───────────┘ └───────────┘ └───────────┘ │
│ │
│ Максимум 3 неподтверждённых сообщения одновременно │
│ │
└─────────────────────────────────────────────────────────────┘



**Почему только 3?**
- Ограничения протокола (размер TXT-записи)
- Ограничения устройств (максимум сервисов)
- Здравый смысл (дождись ответа, прежде чем спамить)

---

## 🔄 Жизненный цикл сообщения

### Сценарий 1: Успешная доставка
┌─────────────────────────────────────────────────────────────┐
│ ✅ УСПЕШНАЯ ДОСТАВКА (2-10 секунд) │
├─────────────────────────────────────────────────────────────┤
│ │
│ 📱 Устройство A 📱 Устройство B │
│ (отправитель) (получатель) │
│ │
│ 1. Ввод "Привет!" │
│ │ │
│ ▼ │
│ 2. Создаём ID: "a1b2_695b_1" │
│ (позывной_сессия_номер) │
│ │ │
│ ▼ │
│ 3. Публикуем WFD_Msg0 ─────────────► 4. Сканируем эфир │
│ Нашли WFD_Msg0! │
│ │ │
│ ▼ │
│ 5. "Привет!" от A │
│ Сохраняем │
│ │ │
│ ▼ │
│ 6. Публикуем WFD_Ack │
│ ◄─────────────────────────────────────┘ │
│ 7. Видим ACK с нашим ID │
│ │ │
│ ▼ │
│ 8. Удаляем слот │
│ Статус: ✅ Доставлено │
│ │
└─────────────────────────────────────────────────────────────┘




### Сценарий 2: Получатель временно недоступен
┌─────────────────────────────────────────────────────────────┐
│ ⏳ ДОСТАВКА ПРИ ВРЕМЕННОМ СБОЕ │
├─────────────────────────────────────────────────────────────┤
│ │
│ Время 📱 Устройство A 📱 Устройство B │
│ ───── ────────────── ────────────── │
│ │
│ 00:00 Отправка "Привет" 📱 Онлайн │
│ WFD_Msg0 создан │
│ │
│ 00:05 Ждём ACK... 📴 Экран выключен │
│ WiFi спит │
│ │
│ 00:30 ⚠️ Таймаут! │
│ "Slot extended" │
│ Ждём ещё... │
│ │
│ 00:45 📱 Проснулся! │
│ │
│ 00:47 ─────────────────────► Сканирование... │
│ Нашёл WFD_Msg0! │
│ │
│ 00:48 ◄───────────────────── ACK отправлен │
│ Получили ACK! │
│ │
│ 00:48 ✅ Доставлено! │
│ │
└─────────────────────────────────────────────────────────────┘

💡 Слот "держит" сообщение до 60 секунд




---

## 🔄 Синхронизация — восстановление после сбоев

### Проблема

Что если ACK потерялся?
1. A отправил → B получил ✅
2. B отправил ACK → **ACK не дошёл** ❌
3. A думает: «не доставлено» 😕
4. B думает: «всё ок» 🤷

### Решение: протокол SYNC

Каждую минуту устройства обмениваются «журналами связи»:
📡 WFD_Sync:
id = "a1b2c3d4" ← Кто я
to = "b5c6d7e8" ← Кому пишу
sent = "a1b2_1,a1b2_2,a1b2_3" ← Что отправлял тебе
recv = "b5c6_1,b5c6_2" ← Что получал от тебя




### Алгоритм восстановления
┌─────────────────────────────────────────────────────────────┐
│ 🔄 СИНХРОНИЗАЦИЯ СОСТОЯНИЙ │
├─────────────────────────────────────────────────────────────┤
│ │
│ 📱 Устройство A 📱 Устройство B │
│ │
│ Мой журнал: Мой журнал: │
│ • Отправил: [msg_1, msg_2] • Получил: [msg_1, msg_2]
│ • msg_1 ✅ ACK • Отправил ACK на оба │
│ • msg_2 ⏳ жду ACK │
│ │
│ ─────────────────────────────────────────────────────────│
│ │
│ 1. Публикую SYNC: │
│ sent=[msg_1, msg_2] ───────────► 2. Вижу SYNC от A │
│ Сравниваю: │
│ Мой recv = [1, 2] │
│ Его sent = [1, 2] │
│ ✅ Совпадает! │
│ │
│ 3. Публикую SYNC: │
│ ◄───────────────────────────── recv=[msg_1, msg_2]│
│ 4. Вижу SYNC от B │
│ Он получил msg_2! │
│ Хотя ACK не дошёл! │
│ │
│ 5. Помечаю msg_2 как ✅ │
│ (доставлено через SYNC) │
│ │
└─────────────────────────────────────────────────────────────┘




### Сценарий 3: Сообщение потерялось полностью
┌─────────────────────────────────────────────────────────────┐
│ 🔧 ВОССТАНОВЛЕНИЕ ЧЕРЕЗ SYNC │
├─────────────────────────────────────────────────────────────┤
│ │
│ 📱 A 📱 B │
│ │
│ Отправил msg_3 ────X────► (не дошло!) │
│ в WFD_Msg0 Помехи в эфире │
│ │
│ Таймаут 60 сек... │
│ Слот освобождён │
│ msg_3 ⏳ статус неизвестен │
│ │
│ ─────────── проходит минута ─────────────────────────────│
│ │
│ Публикую SYNC: │
│ sent=[msg_1,msg_2,msg_3] ─────────► Вижу SYNC от A │
│ Проверяю: │
│ Мой recv = [1, 2] │
│ ⚠️ msg_3 нет! │
│ │
│ Публикую SYNC: │
│ ◄───────────────────────────── recv=[msg_1, msg_2] │
│ Вижу: B НЕ получил msg_3! │
│ │
│ Переотправляю msg_3 ───────────► Теперь получил! │
│ в свободный слот │
│ │
│ ◄───────────────────────────── ACK на msg_3 │
│ │
│ ✅ Наконец доставлено! │
│ │
└─────────────────────────────────────────────────────────────┘



---

## 🆔 Session ID — защита от «призраков»

### Проблема

Устройство B перезапустило приложение:
- Новое состояние
- Пустая история
- Счётчики сброшены

А устройство A помнит старые сообщения и ждёт на них ответа.

### Решение

**Session ID** = timestamp запуска в hex-формате:
695bda95 → запуск в 14:00
695bf5e3 → запуск в 16:00 (новее, число больше)

┌─────────────────────────────────────────────────────────────┐
│ 🔄 ОБРАБОТКА НОВОЙ СЕССИИ │
├─────────────────────────────────────────────────────────────┤
│ │
│ 📱 A помнит: 📱 B перезапустился: │
│ B.sid = 695bda95 Новый sid = 695bf5e3 │
│ │
│ Получаю TXT от B ◄──────────── Публикую WFD_Main │
│ sid = 695bf5e3 sid = 695bf5e3 │
│ │
│ Сравниваю: │
│ 695bf5e3 > 695bda95 │
│ ↓ │
│ 🆕 Новая сессия! │
│ • Очищаю историю для B │
│ • Сбрасываю ожидающие ACK │
│ • Запоминаю новый sid │
│ │
│ ─────────────────────────────────────────────────────────│
│ │
│ Если sid МЕНЬШЕ текущего: │
│ → Это устаревший кэш! Игнорируем. │
│ │
└─────────────────────────────────────────────────────────────┘




---

## 📊 Технические детали

### Карта сервисов

| Сервис | Назначение | Время жизни |
|--------|-----------|-------------|
| `WFD_Main` | Heartbeat, статус, позывной | Постоянно (обновление 5 сек) |
| `WFD_Msg0/1/2` | Слоты сообщений | 30-60 сек (до ACK) |
| `WFD_Ack` | Подтверждения входящих | 10-15 сек |
| `WFD_Sync` | Синхронизация журналов | 30 сек |

### Диаграмма состояний сообщения
text

                ┌─────────────┐
                │   СОЗДАНО   │
                └──────┬──────┘
                       │
                       ▼
                ┌─────────────┐
         ┌──────│   В СЛОТЕ   │──────┐
         │      │  (ждём ACK) │      │
         │      └─────────────┘      │
         │            │              │
    Таймаут      ACK получен    Получатель
    30 сек           │           офлайн
         │            │              │
         ▼            ▼              ▼
┌───────────┐ ┌───────────┐ ┌─────────────┐
│ EXTENDED  │ │✅ ДОСТАВЛ.│ │ РЕПОЗИТОРИЙ │
│ (+30 сек) │ └───────────┘ │ (ждём SYNC) │
└─────┬─────┘               └──────┬──────┘
│                            │
Ещё таймаут                  SYNC нашёл
│                       недоставку
▼                            │
┌───────────┐                      │
│   СЛОТ    │◄─────────────────────┘
│ ОСВОБОЖДЁН│      Переотправка
└─────┬─────┘
│
▼
┌─────────────────┐
│ RESEND │────► Назад в слот
│ (через SYNC) │
└─────────────────┘



---

## 💡 Практические советы

### Характеристики

| Параметр | Значение |
|----------|----------|
| 📏 Дальность в помещении | 30-50 м |
| 📏 Дальность на открытом пространстве | 100-200 м |
| 👥 Максимум устройств | 8-10 практически |
| 📝 Размер сообщения | до 100 символов |
| ⏱️ Задержка доставки | 2-15 секунд |
| 🔋 Энергопотребление | Умеренное |

### Сравнение с альтернативами

| Технология | Дальность | Инфраструктура | Регистрация |
|------------|-----------|----------------|-------------|
| **WiFi Direct** | 100-200 м | ❌ Не нужна | ❌ Не нужна |
| Bluetooth | 10-30 м | ❌ Не нужна | Сопряжение |
| WhatsApp | ∞ | ✅ Интернет | ✅ Номер телефона |
| Telegram | ∞ | ✅ Интернет | ✅ Номер телефона |
| Рация PMR | 1-5 км | ❌ Не нужна | ❌ Не нужна |
| LoRa | 2-15 км | Модуль | ❌ Не нужна |

### Идеальные сценарии использования

✅ **Отлично подходит:**
- 🏕️ Походы и кемпинг
- 🎪 Массовые мероприятия
- 🆘 Аварийные ситуации
- 🎮 Игры на местности
- 👥 Координация групп

❌ **Не подходит:**
- Дальние расстояния (>200 м)
- Критически важные сообщения
- Передача файлов

---

## 📋 Приложение: Формат протокола

### WFD_Main (Heartbeat)
id = a1b2c3d4 # 8 символов hex, ID устройства
sid = 695bf5e3 # Session ID (hex timestamp запуска)
hb = 42 # Номер heartbeat
t = 1705123456 # Unix timestamp
v = 4 # Версия протокола
ack = xyz_1,xyz_2 # Подтверждения (опционально)



### WFD_Msg* (Сообщение)
id = a1b2c3d4 # Отправитель
mid = a1b2_695b_1 # ID сообщения (уникальный)
msg = Привет! # Текст (до 100 символов)
to = b5c6d7e8 # Получатель (опционально)
s = 0 # Номер слота (0, 1 или 2)
t = 1705123456 # Timestamp
sid = 695bf5e3 # Session ID отправителя




### WFD_Ack (Подтверждение)
id = b5c6d7e8 # Кто подтверждает
ack = a1b2_695b_1 # Какое сообщение подтверждено
t = 1705123456 # Timestamp
sid = 695bf5e3 # Session ID




### WFD_Sync (Синхронизация)
id = a1b2c3d4 # Кто отправил SYNC
to = b5c6d7e8 # Кому адресовано
sent = a1b2_1,a1b2_2,a1b2_3 # Мои отправленные
recv = b5c6_1,b5c6_2 # Мной полученные
t = 1705123456 # Timestamp
sid = 695bf5e3 # Session ID




---

## 🚀 Быстрый старт

1. **Установи** приложение на Android 5.0+
2. **Включи** WiFi (подключаться никуда не нужно!)
3. **Дай** разрешения (Location для WiFi Direct)
4. **Увидь** других пользователей в списке
5. **Отправь** первое сообщение!
   ┌─────────────────────────────────────────────────────────────┐
   │ │
   │ 🎉 Никакой регистрации! │
   │ 🎉 Никаких паролей! │
   │ 🎉 Никаких QR-кодов! │
   │ 🎉 Никакого интернета! │
   │ │
   │ Включай свою необычную рацию │
   │ и общайся с миром │
   │ БЕСПЛАТНО и БЕЗ СМС! 📡 │
   │ │
   └─────────────────────────────────────────────────────────────┘




---

## 📄 Лицензия

MIT License — используйте свободно!

---

## 🤝 Контрибьюция

Pull requests приветствуются! Особенно интересны:
- Улучшение дальности связи
- Mesh-сети (ретрансляция через промежуточные устройства)
- Шифрование сообщений
- Групповые чаты

---

**73!** 📻

*73 — радиолюбительский код «Наилучшие пожелания»*